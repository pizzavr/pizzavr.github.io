<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Physics Circles Playground</title>
    <style>
        :root{--bg:#222;--panel:rgba(34,34,34,.9);--text:#fff;--border:#333;--btn:#333;--btn-hover:#555;--canvas:#222;--link:#4af}
        body.light-theme{--bg:#fff;--panel:rgba(250,250,250,.95);--text:#222;--border:#ccc;--btn:#e0e0e0;--btn-hover:#d0d0d0;--canvas:#f0f0f0;--link:#05a}
        body{margin:0;overflow:hidden;background:var(--bg);color:var(--text)}
        canvas{background:var(--canvas);display:block}
        #controls-panel{position:fixed;top:0;right:0;width:280px;height:100vh;background:var(--panel);color:var(--text);font-family:sans-serif;padding:20px;box-sizing:border-box;transform:translateX(100%);transition:transform .3s;overflow-y:auto;z-index:100}
        #controls-panel.visible{transform:translateX(0)}
        #toggle-btn{position:fixed;top:10px;right:10px;background:var(--btn);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px 12px;cursor:pointer;z-index:101;font-size:16px;transition:right .3s,background .2s}
        #toggle-btn:hover{background:var(--btn-hover)}
        .control-group{margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border)}
        .control-group h3{margin-top:0;padding-bottom:5px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center}
        .control-group h3 span.toggle-arrow{font-size:1.2em;transition:transform .2s;margin-left:10px;transform:rotate(90deg)}
        .control-group.collapsed .control-content{display:none}
        .control-group.collapsed h3 span.toggle-arrow{transform:rotate(0)}
        .control-item{margin-bottom:10px}
        .control-item label{display:block;margin-bottom:5px}
        button{padding:5px 10px;margin:2px;border:1px solid var(--border);background:var(--btn);color:var(--text);border-radius:4px;cursor:pointer;transition:background .1s}
        button:hover{background:var(--btn-hover)}
        input[type="range"]{vertical-align:middle;width:150px}
        .gravity-input-group input[type="number"],.grid-input-group input[type="number"]{width:50px;text-align:right;margin-right:5px;vertical-align:middle;background:var(--bg);color:var(--text);border:1px solid var(--border)}
        #info-text{position:absolute;top:10px;left:10px;color:var(--text);font-family:sans-serif;user-select:none}
        input[type="color"]{height:25px;border:none;padding:0;margin:0;vertical-align:middle}
        .editor-panel{position:absolute;background:var(--btn);color:var(--text);padding:12px;border-radius:8px;z-index:10;font-size:14px;box-shadow:0 4px 8px rgba(0,0,0,.5);border:1px solid var(--border)}
        .editor-panel input[type="number"],.editor-panel input[type="text"]{width:60px;margin-left:5px;background:var(--bg);border:1px solid var(--border);color:var(--text)}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:200;font-family:sans-serif}
        .modal-content{background:var(--bg);color:var(--text);padding:30px;border-radius:10px;max-width:90%;width:500px;max-height:90%;box-shadow:0 0 20px rgba(255,255,255,.2);overflow:auto}
        .modal-content h2{border-bottom:2px solid var(--link);padding-bottom:10px;margin-top:0}
        #saveDataTextarea,#loadDataTextarea{width:100%;min-height:200px;background:#111;color:#0f0;border:1px solid #555;padding:10px;box-sizing:border-box;resize:vertical;font-family:monospace}
        .feedback-item{display:flex;justify-content:space-between;padding:2px 0;font-size:14px}
    </style>
</head>
<body class="dark-theme">
    <div id="info-text">**Physics Circles Playground**<br>Click to add circles.<br>Right-click an element to edit its properties.<br>Drag balls to move. Double-click to connect.<br>Hover over an element and press **'D'** to delete it.</div>
    <button id="toggle-btn">Controls â–¶</button>
    <div id="controls-panel">
        <div class="control-group"><h3 class="collapsible-header">Display & Theme <span class="toggle-arrow">â–¶</span></h3><div class="control-content"><div class="control-item"><button id="themeToggleBtn">Theme: Dark ðŸŒ™</button></div><div class="control-item"><button id="velocityBtn">Show Velocity Vectors: Off</button></div><div class="control-item"><button id="speedLabelBtn">Show Speed (VEL): Off</button></div><div class="control-item"><button id="massLabelBtn">Show Mass: On</button></div><div class="control-item"><button id="showGridBtn">Show Grid: Off</button></div></div></div>
        <div class="control-group"><h3 class="collapsible-header">Global Physics <span class="toggle-arrow">â–¶</span></h3><div class="control-content"><div class="control-item"><button id="gravityBtn">Gravity: On</button><div class="gravity-input-group">Manual: <input type="number" id="gravityCustomInput" value="50" step="1" min="-200" max="200">%<button id="applyGravityBtn">Apply</button></div><div>Strength (xG): <input type="range" id="gravitySlider" min="-2.0" max="2.0" step="0.01" value="0.5"><span id="gravityValue">0.50</span></div></div><div class="control-item"><button id="resistanceBtn">Resistance: On</button></div></div></div>
        <div class="control-group"><h3 class="collapsible-header">Boundary Walls <span class="toggle-arrow">â–¶</span></h3><div class="control-content"><div class="control-item"><button id="wallTopBtn">Top Wall: On</button><button id="wallBottomBtn">Bottom Wall: On</button></div><div class="control-item"><button id="wallLeftBtn">Left Wall: On</button><button id="wallRightBtn">Right Wall: On</button></div></div></div>
        <div class="control-group"><h3 class="collapsible-header">Object & Wall Creation <span class="toggle-arrow">â–¶</span></h3><div class="control-content"><div class="control-item"><button id="wallModeBtn">Wall Mode: Off</button></div><div class="control-item"><button id="snapGridBtn">Snap Grid: On</button></div><div class="control-item grid-input-group">Snap Size (px): <input type="number" id="gridSizeInput" value="50" step="10" min="10" max="200"></div></div></div>
        <div class="control-group"><h3 class="collapsible-header">Tools & File Management <span class="toggle-arrow">â–¶</span></h3><div class="control-content"><div class="control-item"><button id="pauseBtn">Pause: Off</button><button id="helpBtn">How to Play ðŸ’¡</button></div><div class="control-item"><button id="saveBtn">Save/Export ðŸ’¾</button><button id="loadBtn">Load/Import ðŸ“¤</button></div><div class="control-item"><button id="deleteModeBtn">Single-Click Delete: Off</button></div><div class="control-item"><button id="clearAllBtn" style="background: #c00;">Clear All</button></div></div></div>
        <div class="control-group"><h3 class="collapsible-header">Feedback <span class="toggle-arrow">â–¶</span></h3><div class="control-content" id="feedback-content"><div class="feedback-item"><span>FPS:</span> <span id="fpsValue">0</span></div><div class="feedback-item"><span>Balls:</span> <span id="ballCount">0</span></div><div class="feedback-item"><span>Springs:</span> <span id="springCount">0</span></div><div class="feedback-item"><span>Custom Walls:</span> <span id="wallCount">0</span></div></div></div>
        <div id="update-board" class="control-group collapsed"><h3 class="collapsible-header">Update Board (v7.1) <span class="toggle-arrow">â–¶</span></h3><div class="control-content"><p>Recent Fixes/Additions:</p><ul><li>**v7.1:** Reorganized sidebar into logical groups.</li><li>**v7.0:** Added **Show Speed (VEL)** numerical label control.</li></ul></div></div>
    </div>
    <canvas id="canvas"></canvas>
    <div id="help-modal" class="modal"><div class="modal-content"><button class="modal-close-btn" data-modal="help-modal" style="background: #c00;">Close X</button><h2>How to Play ðŸ’¡</h2><h3>On the Canvas (Mouse)</h3><ul><li>**Left Click:** Add a new circle (ball).</li><li>**Drag:** Grab a ball to move it. Fling it to apply velocity.</li><li>**Right Click (on an element):** Open the **Editor** to change its properties.</li><li>**Double Click (on a ball):** Start **Connect Mode** (the ball glows yellow). Click a second ball to draw a spring between them.</li></ul><h3>Special Modes & Keys</h3><ul><li>**Wall Mode (Control Panel):** Click and drag on the canvas to draw a permanent wall segment. Corner/Grid Snapping apply.</li><li>**Press 'D':** Hover over a ball, spring, or wall and press **'D'** to delete it instantly.</li><li>**Single-Click Delete Mode:** Turn this on in the panel to delete elements with a single left click.</li></ul></div></div>
    <div id="save-modal" class="modal"><div class="modal-content"><button class="modal-close-btn" data-modal="save-modal" style="background: #c00;">Close X</button><h2>Save / Export Data ðŸ’¾</h2><p>Copy the JSON data below to save your current simulation state.</p><textarea id="saveDataTextarea" readonly></textarea><div class="modal-actions"><button id="copySaveDataBtn" style="background: #4af;">Copy Data</button></div></div></div>
    <div id="load-modal" class="modal"><div class="modal-content"><button class="modal-close-btn" data-modal="load-modal" style="background: #c00;">Close X</button><h2>Load / Import Data ðŸ“¤</h2><p>Paste your saved JSON data here to load the simulation.</p><textarea id="loadDataTextarea"></textarea><div class="modal-actions"><button id="loadDataBtn" style="background: #4af;">Load Simulation</button></div></div></div>
    <script>
        const cv=document.getElementById('canvas'),ctx=cv.getContext('2d');cv.width=innerWidth;cv.height=innerHeight;
        const BASE_G=.5;let GRAV=BASE_G*.5,gravOn=1,showVel=0,showSpd=0,FRIC=.99,resOn=1,RAD=20,SPR_STR=.01,SPR_LEN=100,W_THICK=5,SNAP_DST=20;
        let snapG=1,gridSz=50,showGr=0,theme='dark',wTop=1,wBot=1,wLeft=1,wRight=1,circles=[],springs=[],walls=[],dragB=null,dragOff={x:0,y:0},dragHist=[],selB=null,connMode=0,selSpr=null,delMode=0,showMass=1,paused=0,hovEl=null,wMode=0,curDrwW=null,lastFT=performance.now(),fps=0;
        
        function snap(c){return!snapG||!gridSz?c:Math.round(c/gridSz)*gridSz}
        function snapSt(x,y){let sx=snap(x),sy=snap(y);for(const w of walls){if(Math.hypot(x-w.x1,y-w.y1)<SNAP_DST)return{x:w.x1,y:w.y1,snapped:1};if(Math.hypot(x-w.x2,y-w.y2)<SNAP_DST)return{x:w.x2,y:w.y2,snapped:1}}return{x:sx,y:sy,snapped:snapG}}
        function snapEnd(x,y){return{x:snap(x),y:snap(y)}}
        function getHov(x,y){let b=circles.find(c=>Math.hypot(c.x-x,c.y-y)<c.radius);if(b)return b;let s=springs.find(s=>{let dx=s.b.x-s.a.x,dy=s.b.y-s.a.y,t=((x-s.a.x)*dx+(y-s.a.y)*dy)/(dx*dx+dy*dy);t=Math.max(0,Math.min(1,t));let px=s.a.x+t*dx,py=s.a.y+t*dy;return Math.hypot(px-x,py-y)<10});if(s)return s;let w=walls.find(w=>{const dx=w.x2-w.x1,dy=w.y2-w.y1,lSq=dx*dx+dy*dy,t=Math.max(0,Math.min(1,((x-w.x1)*dx+(y-w.y1)*dy)/(lSq||1))),cx=w.x1+t*dx,cy=w.y1+t*dy;return Math.hypot(x-cx,y-cy)<W_THICK+5});return w||null}
        function delEl(e){if(e instanceof Circle){springs=springs.filter(s=>s.a!==e&&s.b!==e);circles=circles.filter(c=>c!==e);if(selB===e)selB=null;if(dragB===e)dragB=null}else if(e instanceof Spring){springs=springs.filter(s=>s!==e);if(selSpr===e)selSpr=null}else if(e instanceof Wall)walls=walls.filter(w=>w!==e);if(window.bEd)window.bEd.remove();if(window.sEd)window.sEd.remove();if(window.wEd)window.wEd.remove();if(hovEl===e)hovEl=null}
        
        class Circle{constructor(x,y){this.x=x;this.y=y;this.vx=0;this.vy=0;this.mass=1;this.isDragged=0;this.locked=0;this.tx=x;this.ty=y;this.color='#4af';this.label=''}get radius(){return RAD+(this.mass-1)*8}draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);let f=(selB===this)?'#ff0':(this.locked?'#888':this.color);if(hovEl===this){ctx.shadowBlur=15;ctx.shadowColor='red'}ctx.fillStyle=f;ctx.fill();ctx.shadowBlur=0;ctx.strokeStyle=theme==='dark'?'#fff':'#000';ctx.lineWidth=2;ctx.stroke();const lc=theme==='dark'?'#fff':'#222';ctx.font='12px sans-serif';ctx.fillStyle=lc;ctx.textAlign='center';let yo=this.radius+10;if(this.label){ctx.font='14px sans-serif';ctx.fillText(this.label,this.x,this.y-yo);yo+=15;ctx.font='12px sans-serif'}if(showSpd){const sp=Math.hypot(this.vx,this.vy);ctx.fillText('VEL: '+sp.toFixed(1),this.x,this.y-yo);yo+=15}if(showMass)ctx.fillText('m='+this.mass.toFixed(2),this.x,this.y-yo)}update(){if(this.locked){this.vx=0;this.vy=0;return}if(this.isDragged){this.vx=this.x-this.tx;this.vy=this.y-this.ty;this.tx=this.x;this.ty=this.y;return}this.tx=this.x;this.ty=this.y;if(gravOn)this.vy+=GRAV*this.mass;if(resOn){this.vx*=FRIC;this.vy*=FRIC}this.x+=this.vx;this.y+=this.vy;const rest=.7;if(wLeft&&this.x<this.radius){this.x=this.radius;this.vx*=-rest}if(wRight&&this.x>cv.width-this.radius){this.x=cv.width-this.radius;this.vx*=-rest}if(wTop&&this.y<this.radius){this.y=this.radius;this.vy*=-rest}if(wBot&&this.y>cv.height-this.radius){this.y=cv.height-this.radius;this.vy*=-rest}}toJSON(){return{x:this.x,y:this.y,vx:this.vx,vy:this.vy,mass:this.mass,locked:this.locked,color:this.color,label:this.label}}}
        
        class Spring{constructor(a,b){this.a=a;this.b=b;this.length=SPR_LEN;this.strength=SPR_STR;this.selected=0}draw(){ctx.beginPath();ctx.moveTo(this.a.x,this.a.y);ctx.lineTo(this.b.x,this.b.y);let st=this.selected?'#0f0':'#fa4',lw=this.selected?5:3;if(hovEl===this){st='red';lw=5}ctx.strokeStyle=st;ctx.lineWidth=lw;ctx.stroke()}update(){let dx=this.b.x-this.a.x,dy=this.b.y-this.a.y,dist=Math.hypot(dx,dy),force=(dist-this.length)*this.strength,fx=(dx/dist)*force,fy=(dy/dist)*force;if(!this.a.locked){this.a.vx+=fx/this.a.mass;this.a.vy+=fy/this.a.mass}if(!this.b.locked){this.b.vx-=fx/this.b.mass;this.b.vy-=fy/this.b.mass}}toJSON(){return{aIndex:circles.indexOf(this.a),bIndex:circles.indexOf(this.b),length:this.length,strength:this.strength}}}
        
        class Wall{constructor(x1,y1,x2,y2){this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2;this.color='#fff';this.restitution=.8;this.friction=.95}draw(){ctx.beginPath();ctx.moveTo(this.x1,this.y1);ctx.lineTo(this.x2,this.y2);ctx.strokeStyle=this.color;ctx.lineWidth=W_THICK;if(hovEl===this){ctx.shadowBlur=15;ctx.shadowColor='red'}ctx.stroke();ctx.shadowBlur=0}toJSON(){return{x1:this.x1,y1:this.y1,x2:this.x2,y2:this.y2,color:this.color,restitution:this.restitution,friction:this.friction}}}
        
        function drwGrid(){if(!showGr||!gridSz)return;ctx.strokeStyle=theme==='dark'?'rgba(255,255,255,.1)':'rgba(0,0,0,.1)';ctx.lineWidth=1;for(let x=0;x<=cv.width;x+=gridSz){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,cv.height);ctx.stroke()}for(let y=0;y<=cv.height;y+=gridSz){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cv.width,y);ctx.stroke()}}
        function drwVel(){if(!showVel)return;for(let c of circles){let vx=c.vx,vy=c.vy,sp=Math.hypot(vx,vy);if(sp>.5){let aL=Math.min(40,sp*8),ang=Math.atan2(vy,vx),x1=c.x,y1=c.y,x2=x1+Math.cos(ang)*aL,y2=y1+Math.sin(ang)*aL;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.strokeStyle='#0ff';ctx.lineWidth=2;ctx.stroke();ctx.beginPath();ctx.moveTo(x2,y2);ctx.lineTo(x2-Math.cos(ang-Math.PI/6)*8,y2-Math.sin(ang-Math.PI/6)*8);ctx.moveTo(x2,y2);ctx.lineTo(x2-Math.cos(ang+Math.PI/6)*8,y2-Math.sin(ang+Math.PI/6)*8);ctx.stroke()}}}
        function draw(){ctx.clearRect(0,0,cv.width,cv.height);drwGrid();drwVel();for(let s of springs)s.draw();for(let w of walls)w.draw();for(let c of circles)c.draw();if(curDrwW){ctx.beginPath();ctx.moveTo(curDrwW.x1,curDrwW.y1);ctx.lineTo(curDrwW.x2,curDrwW.y2);ctx.strokeStyle=curDrwW.color;ctx.lineWidth=W_THICK;ctx.setLineDash([10,5]);ctx.stroke();ctx.setLineDash([])}if(connMode&&selB){ctx.beginPath();ctx.arc(selB.x,selB.y,selB.radius+6,0,Math.PI*2);ctx.strokeStyle='#ff0';ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([])}}
        function update(){if(paused)return;for(let s of springs)s.update();for(let c of circles)c.update();for(let i=0;i<circles.length;i++){for(let j=i+1;j<circles.length;j++){let a=circles[i],b=circles[j];const aL=a.locked,bL=b.locked;if(aL&&bL)continue;let dx=b.x-a.x,dy=b.y-a.y,dist=Math.hypot(dx,dy),minD=a.radius+b.radius;if(dist<minD){let ang=Math.atan2(dy,dx),ovr=minD-dist;if(aL){b.x+=Math.cos(ang)*ovr;b.y+=Math.sin(ang)*ovr}else if(bL){a.x-=Math.cos(ang)*ovr;a.y-=Math.sin(ang)*ovr}else{let tM=a.mass+b.mass,rA=b.mass/tM,rB=a.mass/tM;a.x-=Math.cos(ang)*ovr*rA;a.y-=Math.sin(ang)*ovr*rA;b.x+=Math.cos(ang)*ovr*rB;b.y+=Math.sin(ang)*ovr*rB}let v1=a.vx*Math.cos(ang)+a.vy*Math.sin(ang),v2=b.vx*Math.cos(ang)+b.vy*Math.sin(ang),m1=aL?99999999:a.mass,m2=bL?99999999:b.mass,tMM=m1+m2,v1f=(v1*(m1-m2)+2*m2*v2)/tMM,v2f=(v2*(m2-m1)+2*m1*v1)/tMM,dv1=v1f-v1,dv2=v2f-v2;if(!aL){a.vx+=dv1*Math.cos(ang);a.vy+=dv1*Math.sin(ang);a.vx*=.95;a.vy*=.95}if(!bL){b.vx+=dv2*Math.cos(ang);b.vy+=dv2*Math.sin(ang);b.vx*=.95;b.vy*=.95}}}}for(let c of circles){for(let w of walls){const dx=w.x2-w.x1,dy=w.y2-w.y1,wLSq=dx*dx+dy*dy;let t=0;if(wLSq!==0){t=((c.x-w.x1)*dx+(c.y-w.y1)*dy)/wLSq;t=Math.max(0,Math.min(1,t))}const cx=w.x1+t*dx,cy=w.y1+t*dy,dSq=Math.pow(c.x-cx,2)+Math.pow(c.y-cy,2),rSq=Math.pow(c.radius,2);if(dSq<rSq){const d=Math.sqrt(dSq),ovr=c.radius-d,nx=(c.x-cx)/d,ny=(c.y-cy)/d;if(!c.locked){c.x+=nx*ovr;c.y+=ny*ovr}const dot=c.vx*nx+c.vy*ny,tVx=c.vx-dot*nx,tVy=c.vy-dot*ny,nTVx=tVx*w.friction,nTVy=tVy*w.friction,nNVx=(c.vx-tVx)*-w.restitution,nNVy=(c.vy-tVy)*-w.restitution;c.vx=nNVx+nTVx;c.vy=nNVy+nTVy}}}}
        function updFb(){const now=performance.now(),dlt=now-lastFT;fps=Math.round(1e3/dlt);lastFT=now;document.getElementById('fpsValue').textContent=fps;document.getElementById('ballCount').textContent=circles.length;document.getElementById('springCount').textContent=springs.length;document.getElementById('wallCount').textContent=walls.length}
        function loop(){update();draw();updFb();requestAnimationFrame(loop)}
        function ser(){const cD=circles.map(c=>c.toJSON()),sD=springs.map(s=>s.toJSON()),wD=walls.map(w=>w.toJSON());return JSON.stringify({circles:cD,springs:sD,walls:wD,global:{gravityOn:gravOn,GRAVITY:GRAV,resistanceOn:resOn,showVelocity:showVel,showMassLabel:showMass,showSpeedLabel:showSpd,wallTopOn:wTop,wallBottomOn:wBot,wallLeftOn:wLeft,wallRightOn:wRight,snapGrid:snapG,gridSize:gridSz,showGrid:showGr,theme}},null,2)}
        function deser(j){try{const d=JSON.parse(j);circles=[];springs=[];walls=[];selB=null;connMode=0;for(const cD of d.circles){const c=new Circle(cD.x,cD.y);c.vx=cD.vx||0;c.vy=cD.vy||0;c.mass=cD.mass!==undefined?cD.mass:1;c.locked=cD.locked||0;c.color=cD.color||'#4af';c.label=cD.label||'';circles.push(c)}for(const sD of d.springs){const a=circles[sD.aIndex],b=circles[sD.bIndex];if(a&&b){const s=new Spring(a,b);s.length=sD.length!==undefined?sD.length:SPR_LEN;s.strength=sD.strength!==undefined?sD.strength:SPR_STR;springs.push(s)}}for(const wD of d.walls){const w=new Wall(wD.x1,wD.y1,wD.x2,wD.y2);w.color=wD.color||'#fff';w.restitution=wD.restitution!==undefined?wD.restitution:.8;w.friction=wD.friction!==undefined?wD.friction:.95;walls.push(w)}if(d.global){gravOn=!!d.global.gravityOn;GRAV=d.global.GRAVITY!==undefined?d.global.GRAVITY:BASE_G;resOn=!!d.global.resistanceOn;showVel=!!d.global.showVelocity;showMass=!!d.global.showMassLabel;showSpd=!!d.global.showSpeedLabel;wTop=!!d.global.wallTopOn;wBot=!!d.global.wallBottomOn;wLeft=!!d.global.wallLeftOn;wRight=!!d.global.wallRightOn;snapG=!!d.global.snapGrid;gridSz=d.global.gridSize!==undefined?d.global.gridSize:50;showGr=!!d.global.showGrid;theme=d.global.theme||'dark';document.body.className=theme+'-theme';updCtrl()}return 1}catch(e){console.error("Failed to load:",e);alert("Error loading simulation state. Please check the JSON format.");return 0}}
        function createEd(e){if(window.bEd)window.bEd.remove();if(window.sEd)window.sEd.remove();if(window.wEd)window.wEd.remove();const p=document.createElement('div');p.className='editor-panel';p.style.left=`${Math.min(e.x||50,cv.width-250)}px`;p.style.top=`${Math.min(e.y||50,cv.height-300)}px`;let h='<h3>Element Editor</h3>';if(e instanceof Circle){window.bEd=p;h+=`<div class="control-item"><label>Radius (Mass):</label><input type="number" id="edit-mass" value="${e.mass.toFixed(2)}" step="0.1" min="0.1"></div><div class="control-item"><label>Color:</label><input type="color" id="edit-color" value="${e.color}"></div><div class="control-item"><label>Label:</label><input type="text" id="edit-label" value="${e.label}" maxlength="10" placeholder="Optional Name"></div><div class="control-item"><button id="edit-lock-btn">${e.locked?'Unlock Position':'Lock Position'}</button></div>`}else if(e instanceof Spring){window.sEd=p;h+=`<div class="control-item"><label>Rest Length:</label><input type="number" id="edit-length" value="${e.length.toFixed(0)}" step="10" min="10"></div><div class="control-item"><label>Strength:</label><input type="number" id="edit-strength" value="${e.strength.toFixed(3)}" step="0.001" min="0.001" max="1.0"></div>`}else if(e instanceof Wall){window.wEd=p;h+=`<div class="control-item"><label>Restitution (Bounce):</label><input type="number" id="edit-restitution" value="${e.restitution.toFixed(2)}" step="0.05" min="0.0" max="1.0"></div><div class="control-item"><label>Friction (Slipperiness):</label><input type="number" id="edit-friction" value="${e.friction.toFixed(2)}" step="0.05" min="0.0" max="1.0"></div><div class="control-item"><label>Color:</label><input type="color" id="edit-color" value="${e.color}"></div>`}h+=`<button id="editor-close-btn">Close</button> <button id="editor-delete-btn" style="background: #c00;">Delete</button>`;p.innerHTML=h;document.body.appendChild(p);p.querySelector('#editor-close-btn').onclick=()=>p.remove();p.querySelector('#editor-delete-btn').onclick=()=>{delEl(e);p.remove()};if(e instanceof Circle){p.querySelector('#edit-mass').onchange=ev=>e.mass=parseFloat(ev.target.value);p.querySelector('#edit-color').onchange=ev=>e.color=ev.target.value;p.querySelector('#edit-label').oninput=ev=>e.label=ev.target.value.trim();p.querySelector('#edit-lock-btn').onclick=ev=>{e.locked=!e.locked;ev.target.textContent=e.locked?'Unlock Position':'Lock Position'}}else if(e instanceof Spring){p.querySelector('#edit-length').onchange=ev=>e.length=parseFloat(ev.target.value);p.querySelector('#edit-strength').onchange=ev=>e.strength=parseFloat(ev.target.value)}else if(e instanceof Wall){p.querySelector('#edit-restitution').onchange=ev=>e.restitution=parseFloat(ev.target.value);p.querySelector('#edit-friction').onchange=ev=>e.friction=parseFloat(ev.target.value);p.querySelector('#edit-color').onchange=ev=>e.color=ev.target.value}}
        
        const cpan=document.getElementById('controls-panel'),tbtn=document.getElementById('toggle-btn');
        function updCtrl(){document.getElementById('pauseBtn').textContent=paused?'Resume: On':'Pause: Off';document.getElementById('deleteModeBtn').textContent=`Single-Click Delete: ${delMode?'On':'Off'}`;document.getElementById('wallModeBtn').textContent=`Wall Mode: ${wMode?'On':'Off'}`;document.getElementById('snapGridBtn').textContent=`Snap Grid: ${snapG?'On':'Off'}`;document.getElementById('showGridBtn').textContent=`Show Grid: ${showGr?'On':'Off'}`;document.getElementById('gridSizeInput').value=gridSz;document.getElementById('gravityBtn').textContent=`Gravity: ${gravOn?'On':'Off'}`;document.getElementById('resistanceBtn').textContent=`Resistance: ${resOn?'On':'Off'}`;document.getElementById('gravitySlider').value=(GRAV/BASE_G).toFixed(2);document.getElementById('gravityValue').textContent=(GRAV/BASE_G).toFixed(2);document.getElementById('gravityCustomInput').value=(GRAV/BASE_G*100).toFixed(0);document.getElementById('wallTopBtn').textContent=`Top Wall: ${wTop?'On':'Off'}`;document.getElementById('wallBottomBtn').textContent=`Bottom Wall: ${wBot?'On':'Off'}`;document.getElementById('wallLeftBtn').textContent=`Left Wall: ${wLeft?'On':'Off'}`;document.getElementById('wallRightBtn').textContent=`Right Wall: ${wRight?'On':'Off'}`;document.getElementById('velocityBtn').textContent=`Show Velocity Vectors: ${showVel?'On':'Off'}`;document.getElementById('speedLabelBtn').textContent=`Show Speed (VEL): ${showSpd?'On':'Off'}`;document.getElementById('massLabelBtn').textContent=`Show Mass: ${showMass?'On':'Off'}`;const tT=theme==='dark'?'Dark ðŸŒ™':'Light â˜€ï¸';document.getElementById('themeToggleBtn').textContent=`Theme: ${tT}`}
        
        document.getElementById('themeToggleBtn').onclick=()=>{theme=theme==='dark'?'light':'dark';document.body.className=theme+'-theme';updCtrl()};
        tbtn.onclick=()=>{const vis=cpan.classList.toggle('visible');tbtn.textContent=vis?'Controls â—€':'Controls â–¶';tbtn.style.right=vis?'300px':'10px'};
        document.querySelectorAll('.collapsible-header').forEach(h=>h.onclick=function(){this.parentNode.classList.toggle('collapsed')});
        document.querySelectorAll('.control-group').forEach(g=>{if(g.id==='update-board')g.classList.add('collapsed')});
        document.getElementById('gravityBtn').onclick=()=>{gravOn=!gravOn;updCtrl()};
        document.getElementById('resistanceBtn').onclick=()=>{resOn=!resOn;updCtrl()};
        document.getElementById('gravitySlider').oninput=e=>{const sc=parseFloat(e.target.value);GRAV=sc*BASE_G;updCtrl()};
        document.getElementById('applyGravityBtn').onclick=()=>{const cS=parseFloat(document.getElementById('gravityCustomInput').value)/100;if(!isNaN(cS)){GRAV=cS*BASE_G;updCtrl()}};
        document.getElementById('wallTopBtn').onclick=()=>{wTop=!wTop;updCtrl()};
        document.getElementById('wallBottomBtn').onclick=()=>{wBot=!wBot;updCtrl()};
        document.getElementById('wallLeftBtn').onclick=()=>{wLeft=!wLeft;updCtrl()};
        document.getElementById('wallRightBtn').onclick=()=>{wRight=!wRight;updCtrl()};
        document.getElementById('velocityBtn').onclick=()=>{showVel=!showVel;updCtrl()};
        document.getElementById('speedLabelBtn').onclick=()=>{showSpd=!showSpd;updCtrl()};
        document.getElementById('massLabelBtn').onclick=()=>{showMass=!showMass;updCtrl()};
        document.getElementById('pauseBtn').onclick=()=>{paused=!paused;updCtrl()};
        document.getElementById('clearAllBtn').onclick=()=>{if(confirm("Are you sure you want to clear ALL balls, springs, and walls?")){circles=[];springs=[];walls=[];selB=null;connMode=0;if(window.bEd)window.bEd.remove();if(window.sEd)window.sEd.remove();if(window.wEd)window.wEd.remove()}};
        document.getElementById('deleteModeBtn').onclick=()=>{delMode=!delMode;updCtrl()};
        document.getElementById('wallModeBtn').onclick=()=>{wMode=!wMode;updCtrl();if(wMode){connMode=0;selB=null}};
        document.getElementById('snapGridBtn').onclick=()=>{snapG=!snapG;updCtrl()};
        document.getElementById('showGridBtn').onclick=()=>{showGr=!showGr;updCtrl()};
        document.getElementById('gridSizeInput').onchange=e=>{gridSz=parseInt(e.target.value);if(isNaN(gridSz)||gridSz<10)gridSz=10;updCtrl()};
        
        const hMod=document.getElementById('help-modal'),sMod=document.getElementById('save-modal'),lMod=document.getElementById('load-modal'),sTxt=document.getElementById('saveDataTextarea'),lTxt=document.getElementById('loadDataTextarea');
        document.getElementById('helpBtn').onclick=()=>hMod.style.display='flex';
        document.getElementById('saveBtn').onclick=()=>{sTxt.value=ser();sMod.style.display='flex'};
        document.getElementById('copySaveDataBtn').onclick=()=>{sTxt.select();document.execCommand('copy');alert('Simulation data copied to clipboard!')};
        document.getElementById('loadBtn').onclick=()=>{lTxt.value='';lMod.style.display='flex'};
        document.getElementById('loadDataBtn').onclick=()=>{const ok=deser(lTxt.value);if(ok)lMod.style.display='none'};
        document.querySelectorAll('.modal-close-btn').forEach(b=>b.onclick=()=>document.getElementById(b.dataset.modal).style.display='none');
        window.onclick=ev=>{if(ev.target.classList.contains('modal'))ev.target.style.display='none'};
        
        let mX=0,mY=0,isDrg=0;
        cv.onmousemove=e=>{mX=e.clientX;mY=e.clientY;if(isDrg&&dragB){dragB.x=mX+dragOff.x;dragB.y=mY+dragOff.y;if(dragB.locked){dragB.tx=dragB.x;dragB.ty=dragB.y}}else if(isDrg&&wMode&&curDrwW){const sE=snapEnd(mX,mY);curDrwW.x2=sE.x;curDrwW.y2=sE.y}else{if(!document.querySelector('.editor-panel')){const nH=getHov(mX,mY);if(nH!==hovEl)hovEl=nH}}};
        cv.onmousedown=e=>{if(e.clientX>cv.width-cpan.offsetWidth&&cpan.classList.contains('visible'))return;if(e.target.closest('.editor-panel'))return;mX=e.clientX;mY=e.clientY;hovEl=getHov(mX,mY);if(e.button===2){e.preventDefault();if(hovEl){let ex,ey;if(hovEl instanceof Circle){ex=hovEl.x;ey=hovEl.y}else if(hovEl instanceof Spring){ex=(hovEl.a.x+hovEl.b.x)/2;ey=(hovEl.a.y+hovEl.b.y)/2;springs.forEach(s=>s.selected=(s===hovEl));selSpr=hovEl}else if(hovEl instanceof Wall){ex=(hovEl.x1+hovEl.x2)/2;ey=(hovEl.y1+hovEl.y2)/2}createEd(hovEl)}else{springs.forEach(s=>s.selected=0);selSpr=null}return}if(delMode&&hovEl){e.preventDefault();delEl(hovEl);hovEl=null;return}if(wMode){const sS=snapSt(mX,mY);curDrwW=new Wall(sS.x,sS.y,sS.x,sS.y);isDrg=1;return}if(hovEl instanceof Circle){if(hovEl.locked)return;dragB=hovEl;dragB.isDragged=1;dragOff.x=dragB.x-mX;dragOff.y=dragB.y-mY;dragHist=[{x:dragB.x,y:dragB.y,time:performance.now()}];isDrg=1;springs.forEach(s=>s.selected=0);selSpr=null;if(window.sEd)window.sEd.remove();return}if(connMode){if(!hovEl){connMode=0;selB=null}}else{if(!hovEl)circles.push(new Circle(mX,mY))}};
        cv.onmouseup=e=>{if(e.button!==0)return;if(wMode&&curDrwW){if(Math.hypot(curDrwW.x2-curDrwW.x1,curDrwW.y2-curDrwW.y1)>5)walls.push(curDrwW);curDrwW=null;isDrg=0;return}if(dragB){dragB.isDragged=0;if(!paused&&!dragB.locked){const dD=performance.now()-dragHist[0].time,iX=dragHist[0].x,iY=dragHist[0].y;let fVx=(dragB.x-iX)/(dD/1e3)*.1,fVy=(dragB.y-iY)/(dD/1e3)*.1;const mS=100;if(Math.hypot(fVx,fVy)>mS){const rt=mS/Math.hypot(fVx,fVy);fVx*=rt;fVy*=rt}dragB.vx=fVx;dragB.vy=fVy}dragB=null;isDrg=0}const cB=circles.find(c=>Math.hypot(c.x-mX,c.y-mY)<c.radius);if(connMode&&cB&&selB&&selB!==cB){const ex=springs.some(s=>(s.a===selB&&s.b===cB)||(s.a===cB&&s.b===selB));if(!ex)springs.push(new Spring(selB,cB));connMode=0;selB=null}};
        cv.ondblclick=e=>{if(e.clientX>cv.width-cpan.offsetWidth&&cpan.classList.contains('visible'))return;const cB=circles.find(c=>Math.hypot(c.x-e.clientX,c.y-e.clientY)<c.radius);if(cB){if(connMode&&selB===cB){connMode=0;selB=null}else{connMode=1;selB=cB}}else{connMode=0;selB=null}};
        document.addEventListener('keydown',e=>{if(e.key==='d'||e.key==='D'||e.key==='Delete'){if(hovEl){e.preventDefault();delEl(hovEl);hovEl=null}}});
        window.onresize=()=>{cv.width=innerWidth;cv.height=innerHeight};
        updCtrl();loop();
    </script>
</body>
</html>
